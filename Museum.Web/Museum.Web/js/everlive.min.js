/*!
The MIT License (MIT)

Copyright (c) 2013 Telerik AD

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.y distributed under the MIT license.
*/
/*
Everlive SDK
Version 1.1.3
*/
(function(r){var y=Array.prototype.slice;var i="//api.everlive.com/v1/";var m="Id";function l(B,A,z){if(!z){z="The "+A+" is required"}if(typeof B==="undefined"||B===null){throw new Error(z)}}function x(z){this.url=i;this.apiKey=null;this.masterKey=null;this.token=null;this.tokenType=null;this.scheme="http";if(typeof z==="string"){this.apiKey=z}else{_.extend(this,z)}}var o=[];function h(z){var A=this;this.setup=new x(z);_.each(o,function(B){B.func.call(A,z)});if(h.$===null){h.$=A}}h.$=null;h.idField=m;h.initializations=o;h.init=function(z){h.$=null;return new h(z)};h.buildUrl=function(z){var A="";if(typeof z.scheme==="string"){A+=z.scheme+":"}A+=z.url;if(z.apiKey){A+=z.apiKey+"/"}return A};h.prototype.data=function(z){return new g(this.setup,z)};h.prototype.buildUrl=function(){return h.buildUrl(this.setup)};var d=function(B,A){var z=null;if(A&&A.authHeaders===false){return z}if(B.token){z=(B.tokenType||"bearer")+" "+B.token}else{if(B.masterKey){z="masterkey "+B.masterKey}}if(z){return{Authorization:z}}else{return null}};h.prototype.buildAuthHeader=function(){return d(this.setup)};(function(){var B={query:1,where:100,filter:101,and:110,or:111,not:112,equal:120,not_equal:121,lt:122,lte:123,gt:124,gte:125,isin:126,notin:127,all:128,size:129,regex:130,contains:131,startsWith:132,endsWith:133,nearShpere:140,withinBox:141,withinPolygon:142,withinShpere:143,select:200,exclude:201,order:300,order_desc:301,skip:400,take:401};function z(H,G){this.operator=H;this.operands=G||[]}z.prototype={addOperand:function(G){this.operands.push(G)}};function C(H,G,J,I,K){this.filter=H;this.fields=G;this.sort=J;this.toskip=I;this.totake=K;this.expr=new z(B.query)}C.prototype={where:function(G){if(G){return this._simple(B.filter,[G])}else{return new F(this)}},select:function(){return this._simple(B.select,arguments)},order:function(G){return this._simple(B.order,[G])},orderDesc:function(G){return this._simple(B.order_desc,[G])},skip:function(G){return this._simple(B.skip,[G])},take:function(G){return this._simple(B.take,[G])},build:function(){return new D(this).build()},_simple:function(H,I){var G=y.call(I);this.expr.addOperand(new z(H,G));return this}};function F(H,G,I){this.parent=H;this.single=I;this.expr=new z(G||B.where);this.parent.expr.addOperand(this.expr)}F.prototype={and:function(){return new F(this,B.and)},or:function(){return new F(this,B.or)},not:function(){return new F(this,B.not,true)},_simple:function(H){var G=y.call(arguments,1);this.expr.addOperand(new z(H,G));return this._done()},eq:function(G,H){return this._simple(B.equal,G,H)},ne:function(G,H){return this._simple(B.not_equal,G,H)},gt:function(G,H){return this._simple(B.gt,G,H)},gte:function(G,H){return this._simple(B.gte,G,H)},lt:function(G,H){return this._simple(B.lt,G,H)},lte:function(G,H){return this._simple(B.lte,G,H)},isin:function(G,H){return this._simple(B.isin,G,H)},notin:function(G,H){return this._simple(B.notin,G,H)},all:function(G,H){return this._simple(B.all,G,H)},size:function(G,H){return this._simple(B.size,G,H)},regex:function(G,I,H){return this._simple(B.regex,G,I,H)},startsWith:function(G,I,H){return this._simple(B.startsWith,G,I,H)},endsWith:function(G,I,H){return this._simple(B.endsWith,G,I,H)},nearSphere:function(H,J,G,I){return this._simple(B.nearShpere,H,J,G,I)},withinBox:function(G,H,I){return this._simple(B.withinBox,G,H,I)},withinPolygon:function(G,H){return this._simple(B.withinPolygon,G,H)},withinCenterSphere:function(H,G,J,I){return this._simple(B.withinShpere,H,G,J,I)},done:function(){if(this.parent instanceof F){return this.parent._done()}else{return this.parent}},_done:function(){if(this.single){return this.parent}else{return this}}};F.prototype.equal=F.prototype.eq;F.prototype.notEqual=F.prototype.ne;F.prototype.greaterThan=F.prototype.gt;F.prototype.greaterThanEqual=F.prototype.gte;F.prototype.lessThan=F.prototype.lt;F.prototype.lessThanEqual=F.prototype.lte;function D(G){this.query=G;this.expr=G.expr}var A={radians:"$maxDistance",km:"$maxDistanceInKilometers",miles:"$maxDistanceInMiles"};var E={radians:"radius",km:"radiusInKilometers",miles:"radiusInMiles"};D.prototype={build:function(){var G=this.query;if(G.filter||G.fields||G.sort||G.toskip||G.totake){return{$where:G.filter||null,$select:G.fields||null,$sort:G.sort||null,$skip:G.toskip||null,$take:G.totake||null}}return{$where:this._buildWhere(),$select:this._buildSelect(),$sort:this._buildSort(),$skip:this._getSkip(),$take:this._getTake()}},_getSkip:function(){var G=_.find(this.expr.operands,function(J,H,I){return J.operator===B.skip});return G?G.operands[0]:null},_getTake:function(){var G=_.find(this.expr.operands,function(J,H,I){return J.operator===B.take});return G?G.operands[0]:null},_buildSelect:function(){var H=_.find(this.expr.operands,function(K,I,J){return K.operator===B.select});var G={};if(H){_.reduce(H.operands,function(I,J){I[J]=1;return I},G);return G}else{return null}},_buildSort:function(){var H=_.filter(this.expr.operands,function(K,I,J){return K.operator===B.order||K.operator===B.order_desc});var G={};if(H.length>0){_.reduce(H,function(I,J){I[J.operands[0]]=J.operator===B.order?1:-1;return I},G);return G}else{return null}},_buildWhere:function(){var H=_.find(this.expr.operands,function(K,I,J){return K.operator===B.where});if(H){return this._build(new z(B.and,H.operands))}else{var G=_.find(this.expr.operands,function(K,I,J){return K.operator===B.filter});if(G){return G.operands[0]}return null}},_build:function(G){if(this._isSimple(G)){return this._simple(G)}else{if(this._isRegex(G)){return this._regex(G)}else{if(this._isGeo(G)){return this._geo(G)}else{if(this._isAnd(G)){return this._and(G)}else{if(this._isOr(G)){return this._or(G)}else{if(this._isNot(G)){return this._not(G)}}}}}}},_isSimple:function(G){return G.operator>=B.equal&&G.operator<=B.size},_simple:function(G){var K={},H={};var I=G.operands;var J=this._translateoperator(G.operator);if(J){K[J]=I[1]}else{K=I[1]}H[I[0]]=K;return H},_isRegex:function(G){return G.operator>=B.regex&&G.operator<=B.endsWith},_regex:function(G){var H={};var J=this._getRegex(G);var K=this._getRegexValue(J);var I=G.operands;H[I[0]]=K;return H},_getRegex:function(G){var I=G.operands[1];var H=G.operands[2]?G.operands[2]:"";switch(G.operator){case B.regex:return I instanceof RegExp?I:new RegExp(I,H);case B.startsWith:return new RegExp(I+".*",H);case B.endsWith:return new RegExp(".*"+I,H);default:throw new Error("Unknown operator type.")}},_getRegexValue:function(H){var G="";if(H.global){G+="g"}if(H.multiline){G+="m"}if(H.ignoreCase){G+="i"}return{$regex:H.source,$options:G}},_isGeo:function(G){return G.operator>=B.nearShpere&&G.operator<=B.withinShpere},_geo:function(G){var H={};var I=G.operands;H[I[0]]=this._getGeoTerm(G);return H},_getGeoTerm:function(G){switch(G.operator){case B.nearShpere:return this._getNearSphereTerm(G);case B.withinBox:return this._getWithinBox(G);case B.withinPolygon:return this._getWithinPolygon(G);case B.withinShpere:return this._getWithinCenterSphere(G);default:throw new Error("Unknown operator type.")}},_getNearSphereTerm:function(H){var L=H.operands;var G=this._getGeoPoint(L[1]);var I=L[2];var K=L[3];var J;var M={"$nearSphere":G};if(typeof I!=="undefined"){J=A[K]||A.radians;M[J]=I}return M},_getWithinBox:function(H){var I=H.operands;var G=this._getGeoPoint(I[1]);var J=this._getGeoPoint(I[2]);return{"$within":{"$box":[G,J]}}},_getWithinPolygon:function(G){var H=G.operands;var I=this._getGeoPoints(H[1]);return{"$within":{"$polygon":I}}},_getWithinCenterSphere:function(H){var J=H.operands;var G=this._getGeoPoint(J[1]);var K=J[2];var I=J[3];var L=E[I]||E.radians;var M={center:G};M[L]=K;return{"$within":{"$centerSphere":M}}},_getGeoPoint:function(G){if(_.isArray(G)){return new j(G[0],G[1])}return G},_getGeoPoints:function(G){var H=this;return _.map(G,function(I){return H._getGeoPoint(I)})},_isAnd:function(G){return G.operator===B.and},_and:function(G){var H,I,L,K={};var J=G.operands;for(H=0,I=J.length;H<I;H++){L=this._build(J[H]);K=this._andAppend(K,L)}return K},_andAppend:function(G,L){var H,K,I,N,M;var J=_.keys(L);for(H=0,K=J.length;H<K;H++){I=J[H];N=G[I];if(typeof N==="undefined"){G[I]=L[I]}else{M=L[I];if(typeof N==="object"&&typeof M==="object"){N=_.extend(N,M)}else{N=M}G[I]=N}}return G},_isOr:function(G){return G.operator===B.or},_or:function(G){var H,I,L,K=[];var J=G.operands;for(H=0,I=J.length;H<I;H++){L=this._build(J[H]);K.push(L)}return{$or:K}},_isNot:function(G){return G.operator===B.not},_not:function(G){return{$not:this._build(G.operands[0])}},_translateoperator:function(G){switch(G){case B.equal:return null;case B.not_equal:return"$ne";case B.gt:return"$gt";case B.lt:return"$lt";case B.gte:return"$gte";case B.lte:return"$lte";case B.isin:return"$in";case B.notin:return"$nin";case B.all:return"$all";case B.size:return"$size"}throw new Error("Unknown operator type.")}};h.Query=C;h.QueryBuilder=D}());var w=(function(){var B={filter:"X-Everlive-Filter",select:"X-Everlive-Fields",sort:"X-Everlive-Sort",skip:"X-Everlive-Skip",take:"X-Everlive-Take"};function I(M,L){l(M,"setup");l(L,"options");this.setup=M;this.method=null;this.endpoint=null;this.data=null;this.headers={};this.success=null;this.error=null;this.parse=I.parsers.simple;_.extend(this,L);this._init(L)}I.prototype={send:function(){h.sendRequest(this)},buildAuthHeader:d,buildUrl:function A(L){return h.buildUrl(L)},buildQueryHeaders:function z(L){if(L){if(L instanceof h.Query){return I.prototype._buildQueryHeaders(L)}else{return I.prototype._buildFilterHeader(L)}}else{return{}}},_init:function(L){_.extend(this.headers,this.buildAuthHeader(this.setup,L),this.buildQueryHeaders(L.filter),L.headers)},_buildQueryHeaders:function(M){M=M.build();var L={};if(M.$where!==null){L[B.filter]=JSON.stringify(M.$where)}if(M.$select!==null){L[B.select]=JSON.stringify(M.$select)}if(M.$sort!==null){L[B.sort]=JSON.stringify(M.$sort)}if(M.$skip!==null){L[B.skip]=M.$skip}if(M.$take!==null){L[B.take]=M.$take}return L},_buildFilterHeader:function(L){var M={};M[B.filter]=JSON.stringify(L);return M}};h.Request=I;h.prototype.request=function(L){return new I(this.setup,L)};function E(O){var M=O.match(/^(\d{4})(-(\d{2})(-(\d{2})(T(\d{2}):(\d{2})(:(\d{2})(\.(\d+))?)?(Z|((\+|-)(\d{2}):(\d{2}))))?))$/);if(M){var N=M[12];if(N){if(N.length>3){N=Math.round(Number(N.substr(0,3)+"."+N.substr(3)))}else{if(N.length<3){N+=N.length===2?"0":"00"}}}var L=new Date(Date.UTC(Number(M[1]),(Number(M[3])-1)||0,Number(M[5])||0,Number(M[7])||0,Number(M[8])||0,Number(M[10])||0,Number(N)||0));return L}else{return null}}function C(M,N){if(typeof N==="string"){var L=E(N);if(L){N=L}}return N}function J(O,L){var M,P,N;for(M in O){if(O.hasOwnProperty(M)){P=O[M];N=L(M,P);O[M]=N;if(P===N&&typeof P==="object"){J(P,L)}}}}function K(L){J(L,C)}h._traverseAndRevive=K;function F(L){if(typeof L==="string"&&L.length>0){L=JSON.parse(L,C)}else{if(typeof L==="object"){K(L)}}if(L){return{result:L.Result,count:L.Count}}else{return L}}function D(M){if(typeof M==="string"&&M.length>0){try{M=JSON.parse(M);return{message:M.message,code:M.errorCode}}catch(L){return M}}else{return M}}function G(L){if(typeof L==="string"&&L.length>0){L=JSON.parse(L,C)}else{if(typeof L==="object"){K(L)}}if(L){return{result:L.Result}}else{return L}}function H(L){if(typeof L==="string"&&L.length>0){L=JSON.parse(L,C)}else{if(typeof L==="object"){K(L)}}if(L){return{result:L.Result,ModifiedAt:L.ModifiedAt}}else{return L}}I.parsers={simple:{result:F,error:D},single:{result:G,error:D},update:{result:H,error:D}};h.disableRequestCache=function(O,L){if(L==="GET"){var N=(new Date()).getTime();var M=O.indexOf("?")>-1?"&":"?";O+=M+"_el="+N}return O};if(typeof h.sendRequest==="undefined"){h.sendRequest=function(M){var N=M.buildUrl(M.setup)+M.endpoint;N=h.disableRequestCache(N,M.method);var L=M.method==="GET"?M.data:JSON.stringify(M.data);reqwest({url:N,method:M.method,data:L,headers:M.headers,type:"json",contentType:"application/json",crossOrigin:true,success:function(O,Q,P){M.success.call(M,M.parse.result(O))},error:function(P,Q,O){M.error.call(M,M.parse.error(P.responseText))}})}}return I}());h.getCallbacks=function(B,z){var A;if(typeof B!=="function"&&typeof z!=="function"){A=new RSVP.Promise(function(D,C){B=function(E){D(E)};z=function(E){C(E)}})}return{promise:A,success:B,error:z}};function e(B,C,A){var z=h.getCallbacks(C,A);B(z.success,z.error);return z.promise}function p(z,A){return function(C){var B=C.result;if(_.isArray(z)||typeof z.length==="number"){_.each(z,function(E,D){_.extend(E,B[D])})}else{_.extend(z,B)}A(C)}}function q(z,A){return function(C){var B=C.ModifiedAt;z.ModifiedAt=B;A(C)}}function g(A,z){this.setup=A;this.collectionName=z;this.options=null}g.prototype={withHeaders:function(z){var A=this.options||{};A.headers=_.extend(A.headers||{},z);this.options=A;return this},_createRequest:function(z){_.extend(z,this.options);this.options=null;return new w(this.setup,z)},get:function(A,C,z){var B=this;return e(function(F,D){var E=B._createRequest({method:"GET",endpoint:B.collectionName,filter:A,success:F,error:D});E.send()},C,z)},getById:function(A,C,z){var B=this;return e(function(F,D){var E=B._createRequest({method:"GET",endpoint:B.collectionName+"/"+A,parse:w.parsers.single,success:F,error:D});E.send()},C,z)},count:function(A,C,z){var B=this;return e(function(F,D){var E=B._createRequest({method:"GET",endpoint:B.collectionName+"/_count",filter:A,parse:w.parsers.single,success:F,error:D});E.send()},C,z)},create:function(z,C,A){var B=this;return e(function(F,D){var E=B._createRequest({method:"POST",endpoint:B.collectionName,data:z,parse:w.parsers.single,success:p(z,F),error:D});E.send()},C,A)},rawUpdate:function(z,B,D,A){var C=this;return e(function(I,F){var E=C.collectionName;var G=null;if(typeof B==="string"){E+="/"+B}else{if(typeof B==="object"){G=B}}var H=C._createRequest({method:"PUT",endpoint:E,data:z,filter:G,success:I,error:F});H.send()},D,A)},_update:function(z,B,E,C,F,A){var D=this;return e(function(L,I){var H=D.collectionName;var K=L;if(E){H+="/"+z[m];K=q(z,L)}var G={};G[C?"$replace":"$set"]=z;var J=D._createRequest({method:"PUT",endpoint:H,parse:w.parsers.update,data:G,filter:B,success:K,error:I});J.send()},F,A)},updateSingle:function(A,B,z){return this._update(A,null,true,false,B,z)},update:function(B,A,C,z){return this._update(B,A,false,false,C,z)},_destroy:function(z,B,D,E,A){var C=this;return e(function(I,G){var F=C.collectionName;if(D){F+="/"+z[m]}var H=C._createRequest({method:"DELETE",endpoint:F,filter:B,success:I,error:G});H.send()},E,A)},destroySingle:function(A,B,z){return this._destroy(A,null,true,B,z)},destroy:function(A,B,z){return this._destroy(null,A,false,B,z)},setAcl:function(z,B,D,A){var C=this;return e(function(J,G){var F=C.collectionName;if(typeof B==="string"){F+="/"+B}else{if(typeof B==="object"){F+="/"+B[m]}}F+="/_acl";var H,E;if(z==null){H="DELETE"}else{H="PUT";E=z}var I=C._createRequest({method:H,endpoint:F,data:E,success:J,error:G});I.send()},D,A)},setOwner:function(B,A,D,z){var C=this;return e(function(H,F){var E=C.collectionName;if(typeof A==="string"){E+="/"+A}else{if(typeof A==="object"){E+="/"+A[m]}}E+="/_owner";var G=C._createRequest({method:"PUT",endpoint:E,data:{Owner:B},success:H,error:F});G.send()},D,z)},save:function(B,D,z){var C=this;var A=this.isNew(B);return e(function(H,E){function G(I){I.type=A?"create":"update";H(I)}function F(I){I.type=A?"create":"update";E(I)}if(A){return C.create(B,G,F)}else{return C.updateSingle(B,G,F)}},D,z)},isNew:function(z){return typeof z[m]==="undefined"}};h.Data=g;function j(A,z){this.longitude=A||0;this.latitude=z||0}h.GeoPoint=j;var c={unauthenticated:"unauthenticated",masterKey:"masterKey",invalidAuthentication:"invalidAuthentication",authenticated:"authenticated"};h.AuthStatus=c;function k(D,B,E,z){if(D.masterKey){return e(function(G,F){G({status:c.masterKey})},E,z)}if(!D.token){return e(function(G,F){G({status:c.unauthenticated})},E,z)}var A;if(E){A=function(F){if(F&&F.code===601){E({status:c.invalidAuthentication})}else{z(F)}}}var C=B(E,A);if(C){C=C.then(function(F){return{status:c.authenticated,user:F.result}},function(F){if(F&&F.code===601){return{status:c.invalidAuthentication}}else{throw F}})}return C}h.prototype.authInfo=function(A,z){return k(this.setup,_.bind(this.Users.getById,this.Users,"me"),A,z)};var b=function(z){z._loginSuccess=function(A){var B=A.result;var C=this.setup;C.token=B.access_token;C.tokenType=B.token_type};z._logoutSuccess=function(){var A=this.setup;A.token=null;A.tokenType=null};z.register=function(F,C,A,D,B){l(F,"username");l(C,"password");var E={Username:F,Password:C};_.extend(E,A);return this.create(E,D,B)};z.login=function(E,B,D,A){var C=this;return e(function(H,F){var G=new w(C.setup,{method:"POST",endpoint:"oauth/token",data:{username:E,password:B,grant_type:"password"},authHeaders:false,parse:w.parsers.single,success:function(){C._loginSuccess.apply(C,arguments);H.apply(null,arguments)},error:F});G.send()},D,A)};z.currentUser=function(C,A){var B=this;return e(function(E,D){k(B.setup,_.bind(B.getById,B,"me")).then(function(F){if(typeof F.user!=="undefined"){E({result:F.user})}else{E({result:null})}},function(F){D(F)})},C,A)};z.changePassword=function(G,D,C,B,F,A){var E=this;return e(function(K,I){var H="Users/changepassword";if(B){H+="?keepTokens=true"}var J=new w(E.setup,{method:"POST",endpoint:H,data:{Username:G,Password:D,NewPassword:C},authHeaders:false,parse:w.parsers.single,success:K,error:I});J.send()},F,A)};z.logout=function(C,A){var B=this;return e(function(F,D){var E=new w(B.setup,{method:"GET",endpoint:"oauth/logout",success:function(){B._logoutSuccess.apply(B,arguments);F.apply(null,arguments)},error:D});E.send()},C,A)};z._loginWithProvider=function(C,A,E,B){var F={Identity:{Provider:C,Token:A}};var D=this;return e(function(I,G){var H=new w(D.setup,{method:"POST",endpoint:"Users",data:F,authHeaders:false,parse:w.parsers.single,success:function(){D._loginSuccess.apply(D,arguments);I.apply(null,arguments)},error:G});H.send()},E,B)};z._linkWithProvider=function(D,G,A,F,B){var C={Provider:D,Token:A};var E=this;return e(function(J,H){var I=new w(E.setup,{method:"POST",endpoint:"Users/"+G+"/link",data:C,parse:w.parsers.single,success:J,error:H});I.send()},F,B)};z._unlinkFromProvider=function(C,F,E,A){var B={Provider:C};var D=this;return e(function(I,G){var H=new w(D.setup,{method:"POST",endpoint:"Users/"+F+"/unlink",data:B,parse:w.parsers.single,success:I,error:G});H.send()},E,A)};z.loginWithFacebook=function(A,C,B){return z._loginWithProvider("Facebook",A,C,B)};z.linkWithFacebook=function(D,A,C,B){return z._linkWithProvider("Facebook",D,A,C,B)};z.unlinkFromFacebook=function(C,B,A){return z._unlinkFromProvider("Facebook",C,B,A)};z.loginWithLiveID=function(A,C,B){return z._loginWithProvider("LiveID",A,C,B)};z.linkWithLiveID=function(D,A,C,B){return z._linkWithProvider("LiveID",D,A,C,B)};z.unlinkFromLiveID=function(C,B,A){return z._unlinkFromProvider("LiveID",C,B,A)};z.loginWithGoogle=function(A,C,B){return z._loginWithProvider("Google",A,C,B)};z.linkWithGoogle=function(D,A,C,B){return z._linkWithProvider("Google",D,A,C,B)};z.unlinkFromGoogle=function(C,B,A){return z._unlinkFromProvider("Google",C,B,A)}};var a=function(z){z.getUploadUrl=function(){return h.buildUrl(this.setup)+this.collectionName};z.getDownloadUrl=function(A){return h.buildUrl(this.setup)+this.collectionName+"/"+A+"/Download"};z._getUpdateUrl=function(A){return this.collectionName+"/"+A+"/Content"};z.getUpdateUrl=function(A){return h.buildUrl(this.setup)+this._getUpdateUrl(A)};z.updateContent=function(C,B,E,A){var D=this;return e(function(I,G){var F=D._getUpdateUrl(C);var H=D._createRequest({method:"PUT",endpoint:F,data:B,success:I,error:G});H.send()},E,A)}};var t={WindowsPhone:1,Windows8:2,Android:3,iOS:4,OSX:5,Blackberry:6,Nokia:7,Unknown:100};h.PushCallbacks={};var u=function(z){this._el=z;this._currentDevice;this.notifications=z.data("Push/Notifications");this.devices=z.data("Push/Devices")};u.prototype={currentDevice:function(z){if(!window.cordova){throw new Error("Error: currentDevice() can only be called from within a hybrid mobile app, after 'deviceready' event has been fired.")}if(!this._currentDevice){this._currentDevice=new f(this);this._currentDevice.emulatorMode=z}return this._currentDevice}};var v={iOS:{badge:true,sound:true,alert:true},android:{senderID:null},notificationCallbackAndroid:null,notificationCallbackIOS:null};var f=function(z){this._pushHandler=z;this._initSuccessCallback=null;this._initErrorCallback=null;this._globalFunctionSuffix=null;this.pushSettings=null;this.pushToken=null;this.isInitialized=false;this.isInitializing=false;this.emulatorMode=false};f.prototype={enableNotifications:function(A,B,z){this.pushSettings=A;return e(_.bind(this._initialize,this),B,z)},disableNotifications:function(B,z){var A=this;return this.unregister().then(function(){return e(function(E,C){if(A.emulatorMode){E()}else{var D=window.plugins.pushNotification;D.unregister(function(){A.isInitialized=false;E()},C)}},B,z)},z)},getRegistration:function(B,A){var z=this._getDeviceId();return this._pushHandler.devices.getById("HardwareId/"+z,B,A)},register:function(z,D,B){var C=this;var A={};if(z!==undefined){A.Parameters=z}return this._populateRegistrationObject(A).then(function(){return C._pushHandler.devices.create(A,D,B)},B)},unregister:function(B,A){var z=device.uuid;return this._pushHandler.devices.destroySingle({Id:"HardwareId/"+z},B,A)},updateRegistration:function(z,D,B){var C=this;var A={};if(z!==undefined){A.Parameters=z}return this._populateRegistrationObject(A).then(function(){A.Id="HardwareId/"+A.HardwareId;return C._pushHandler.devices.updateSingle(A,D,B)},B)},_initialize:function(H,B){var G=this;if(this.isInitializing){B(new Error("Push notifications are currently initializing."));return}if(!this.emulatorMode&&(!window.plugins||!window.plugins.pushNotification)){B(new Error("The push notifications plugin is not initialized."));return}this._initSuccessCallback=H;this._initErrorCallback=B;if(this.isInitialized){this._deviceRegistrationSuccess(this.pushToken);return}if(this.emulatorMode){setTimeout(function(){G._deviceRegistrationSuccess("fake_push_token")},1000);return}this.isInitializing=true;var I=this._globalFunctionSuffix;if(!I){I=Date.now().toString();this._globalFunctionSuffix=I}var F=window.plugins.pushNotification;var E=this._getPlatformType(device.platform);if(E===t.iOS){var z="apnCallback_"+I;h.PushCallbacks[z]=_.bind(this._onNotificationAPN,this);var A=this.pushSettings.iOS;this._validateIOSSettings(A);A.ecb="Everlive.PushCallbacks."+z;F.register(_.bind(this._successfulRegistrationAPN,this),_.bind(this._failedRegistrationAPN,this),A)}else{if(E===t.Android){var C="gcmCallback_"+I;h.PushCallbacks[C]=_.bind(this._onNotificationGCM,this);var D=this.pushSettings.android;this._validateAndroidSettings(D);D.ecb="Everlive.PushCallbacks."+C;F.register(_.bind(this._successSentRegistrationGCM,this),_.bind(this._errorSentRegistrationGCM,this),D)}else{throw new Error("The current platform is not supported: "+device.platform)}}},_validateAndroidSettings:function(z){if(!z.senderID){throw new Error("Sender ID (project number) is not set in the android settings.")}},_validateIOSSettings:function(z){},_populateRegistrationObject:function(z,C,A){var B=this;return e(function(E,D){if(!B.pushToken){throw new Error("Push token is not available.")}B._getLocaleName(function(I){var F=B._getDeviceId();var G=device.name;var J=B._getPlatformType(device.platform);var M=jstz.determine().name();var L=B.pushToken;var H=I.value;var K=device.version;z.HardwareId=F;z.HardwareModel=G;z.PlatformType=J;z.PlatformVersion=K;z.TimeZone=M;z.PushToken=L;z.Locale=H;E()},D)},C,A)},_getLocaleName:function(A,z){if(this.emulatorMode){A({value:"en_US"})}else{navigator.globalization.getLocaleName(function(B){A(B)},z);navigator.globalization.getLocaleName(function(B){},z)}},_getDeviceId:function(){return device.uuid},_getPlatformType:function(z){var A=z.toLowerCase();switch(A){case"ios":case"iphone":case"ipad":return t.iOS;case"android":return t.Android;case"wince":return t.WindowsPhone;default:return t.Unknown}},_deviceRegistrationFailed:function(z){this.pushToken=null;this.isInitializing=false;this.isInitialized=false;if(this._initErrorCallback){this._initErrorCallback({error:z})}},_deviceRegistrationSuccess:function(z){this.pushToken=z;this.isInitializing=false;this.isInitialized=true;if(this._initSuccessCallback){this._initSuccessCallback({token:z})}},_successfulRegistrationAPN:function(z){this._deviceRegistrationSuccess(z)},_failedRegistrationAPN:function(z){this._deviceRegistrationFailed(z)},_successSentRegistrationGCM:function(z){},_errorSentRegistrationGCM:function(z){this._deviceRegistrationFailed(z)},_onNotificationAPN:function(z){this._raiseNotificationEventIOS(z)},_onNotificationGCM:function s(z){switch(z.event){case"registered":if(z.regid.length>0){this._deviceRegistrationSuccess(z.regid)}break;case"message":this._raiseNotificationEventAndroid(z);break;case"error":if(!this.pushToken){this._deviceRegistrationFailed(z)}else{this._raiseNotificationEventAndroid(z)}break;default:this._raiseNotificationEventAndroid(z);break}},_raiseNotificationEventAndroid:function(z){if(this.pushSettings.notificationCallbackAndroid){this.pushSettings.notificationCallbackAndroid(z)}},_raiseNotificationEventIOS:function(z){if(this.pushSettings.notificationCallbackIOS){this.pushSettings.notificationCallbackIOS(z)}}};var n=function(){this.Users=this.data("Users");b(this.Users);this.Files=this.data("Files");a(this.Files);this.push=new u(this)};o.push({name:"default",func:n});r.Everlive=h}(this));
